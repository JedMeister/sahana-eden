#!/bin/sh -ex

DB_NAME=eden
DB_USER=eden
DB_PASS=$(mcookie)

SRC=/usr/local/src
W2PROOT=/var/www/web2py
EDENROOT=$W2PROOT/applications/eden

# remove web2py example apps
rm -rf $W2PROOT/applications/welcome
rm -rf $W2PROOT/applications/examples

# unpack and install tweepy
tar -zxf $SRC/tweepy-*.tar.gz -C $SRC
rm $SRC/tweepy-*.tar.gz
cd $SRC/tweepy-*
python setup.py install
cd /
rm -rf $SRC/tweepy-*

# setup matplotlib
sed -i "s|^backend      : TkAgg|backend      : Agg|" /etc/matplotlibrc
mkdir -p /var/www/.matplotlib
chown www-data:www-data /var/www/.matplotlib

# unpack eden and create required directories
tar -zxf $SRC/flavour-eden-*.tar.gz -C $W2PROOT/applications/
rm $SRC/flavour-eden-*.tar.gz
mv $W2PROOT/applications/flavour-eden-* $EDENROOT

mkdir -p $EDENROOT/static/cache/chart
mkdir -p $EDENROOT/uploads/gis_cache
mkdir -p $EDENROOT/uploads/images
mkdir -p $EDENROOT/uploads/tracks

